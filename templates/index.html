<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I2C Device Manager</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .section { margin: 20px 0; }
        .device { border: 1px solid #ccc; padding: 10px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>I2C Device Manager</h1>

    <div class="section">
        <h2>Active Devices</h2>
        <div id="active-devices"></div>
    </div>

    <div class="section">
        <h2>New Devices</h2>
        <div id="new-devices"></div>
    </div>

    <div class="section">
        <h2>Archived Devices</h2>
        <div id="archived-devices"></div>
    </div>

    <script>
        // Assume socket is initialized elsewhere, e.g., via Socket.IO
        const socket = io(); // Placeholder for actual socket initialization
        let config = {};
        let prevConfig = {};

        // Deep equality comparison function
        function deepEqual(obj1, obj2) {
            if (obj1 === obj2) return true;
            if (typeof obj1 !== 'object' || typeof obj2 !== 'object' || obj1 == null || obj2 == null) return false;
            let keys1 = Object.keys(obj1), keys2 = Object.keys(obj2);
            if (keys1.length !== keys2.length) return false;
            for (let key of keys1) {
                if (!keys2.includes(key) || !deepEqual(obj1[key], obj2[key])) return false;
            }
            return true;
        }

        // Update UI based on new configuration
        function updateUI(newConfig) {
            if (deepEqual(newConfig, config)) {
                console.log('Configuration unchanged, skipping UI update');
                return;
            }
            console.log('Configuration changed, updating UI');

            updateSection('active-devices', newConfig.connections.filter(conn => conn.active), true);
            updateSection('new-devices', newConfig.connections.filter(conn => !conn.active && conn.section === 'new_connections'));
            updateSection('archived-devices', newConfig.connections.filter(conn => !conn.active && conn.section === 'archived'));
        }

        // Update a specific section
        function updateSection(sectionId, connections, isActiveSection = false) {
            const sectionDiv = document.getElementById(sectionId);
            sectionDiv.innerHTML = ''; // Clear existing content
            connections.forEach(conn => {
                console.log(`Placing device ${conn.address} (${conn.name}) in ${isActiveSection ? 'Active' : sectionId === 'new-devices' ? 'New' : 'Archived'} Devices, active: ${conn.active}`);
                sectionDiv.appendChild(createDeviceDiv(conn, isActiveSection));
            });
        }

        // Create a device div (simplified version)
        function createDeviceDiv(conn, isActive) {
            const div = document.createElement('div');
            div.className = 'device';
            div.textContent = `${conn.name} (${conn.address})`;
            if (isActive && conn.ui_components) {
                // Add UI components like sliders or inputs here if needed
            }
            return div;
        }

        // Handle config updates from the server
        socket.on('config_update', (data) => {
            console.log('Received config_update:', data);
            updateUI(data);
            prevConfig = JSON.parse(JSON.stringify(config));
            config = data;
            // Assume processPendingDataEvents() exists elsewhere if needed
        });

        // Placeholder for other functions like processPendingDataEvents if required
    </script>
</body>
</html>
